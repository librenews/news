<div class="news-homepage">
  <header class="news-header">
    <h1>Open News</h1>
    <p class="subtitle">Top stories from your Bluesky feed</p>
  </header>

  <% if @articles.empty? %>
    <div class="empty-state">
      <p>No articles yet. Articles will appear here as they're shared on Bluesky.</p>
    </div>
  <% else %>
    <div class="articles-container">
      <% @articles.each do |article| %>
      <%# Fragment cache each article card - invalidates when article updates %>
      <% cache(article) do %>
      <article class="article-card">
        <div class="article-content <%= 'no-image' unless article.image_url.present? %>">
          <% if article.image_url.present? %>
            <div class="article-image">
              <img src="<%= article.image_url %>" alt="<%= article.title %>" loading="lazy" />
            </div>
          <% end %>
          
          <div class="article-text">
            <h2 class="article-title">
              <%= link_to article.title, article.url, target: "_blank", rel: "noopener noreferrer" %>
            </h2>
            
            <% if article.summary.present? %>
              <p class="article-summary"><%= truncate(article.summary, length: 200) %></p>
            <% elsif article.description.present? %>
              <p class="article-summary"><%= truncate(article.description, length: 200) %></p>
            <% end %>
            
            <div class="article-meta">
              <% if article.published_at.present? %>
                <span class="article-date"><%= time_ago_in_words(article.published_at) %> ago</span>
              <% end %>
              <% if article.author.present? %>
                <span class="article-author">by <%= article.author %></span>
              <% end %>
            </div>
          </div>
        </div>
        
        <div class="article-sources">
          <div class="sources-label">Shared by:</div>
          <div class="source-avatars">
            <%# Use pre-calculated distinct sources from controller %>
            <% distinct_sources = article.instance_variable_get(:@distinct_sources) %>
            <% distinct_sources.each do |post| %>
              <% source = post.source %>
              <% handle = source.profile&.dig("handle") || source.atproto_did %>
              <% avatar_url = source.profile&.dig("avatar") %>
              <% bluesky_url = nil %>
              
              <%# Check if this is a repost - if so, link to the original post %>
              <% collection = post.post&.dig("commit", "collection") %>
              <% if collection == "app.bsky.feed.repost" %>
                <%# Extract original post URI from repost subject %>
                <% subject_uri = post.post&.dig("commit", "record", "subject", "uri") %>
                <% if subject_uri.present? %>
                  <%# Parse AT URI: at://did/app.bsky.feed.post/rkey %>
                  <% uri_match = subject_uri.match(/\Aat:\/\/([^\/]+)\/([^\/]+)\/([^\/]+)\z/) %>
                  <% if uri_match %>
                    <% original_did = uri_match[1] %>
                    <% original_rkey = uri_match[3] %>
                    <%# Use preloaded source instead of database query %>
                    <% original_source = preloaded_source(original_did) %>
                    <% original_handle = original_source&.profile&.dig("handle") || original_did %>
                    <% bluesky_url = "https://bsky.app/profile/#{original_handle}/post/#{original_rkey}" %>
                  <% end %>
                <% end %>
              <% else %>
                <%# Regular post - use its own rkey %>
                <% rkey = post.post&.dig("commit", "rkey") %>
                <% if rkey && handle %>
                  <% bluesky_url = "https://bsky.app/profile/#{handle}/post/#{rkey}" %>
                <% end %>
              <% end %>
              
              <% if bluesky_url.present? %>
                <% display_name = source.profile&.dig("display_name") || handle %>
                <a href="<%= bluesky_url %>" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="source-avatar-link"
                   title="<%= display_name %>">
                  <% if avatar_url.present? %>
                    <img src="<%= avatar_url %>" alt="<%= display_name %>" class="source-avatar" loading="lazy" />
                  <% else %>
                    <div class="source-avatar-placeholder" title="<%= display_name %>">
                      <%= (display_name.presence || handle).first.upcase %>
                    </div>
                  <% end %>
                </a>
              <% end %>
            <% end %>
          </div>
          <%# Use pre-calculated distinct source count %>
          <% distinct_source_count = article.instance_variable_get(:@distinct_source_count) %>
          <% if distinct_source_count > 20 %>
            <span class="more-sources">+<%= distinct_source_count - 20 %> more</span>
          <% end %>
        </div>
      </article>
      <% end %>
      <% end %>
    </div>
  <% end %>
</div>
